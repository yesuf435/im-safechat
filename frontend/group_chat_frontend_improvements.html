<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMèŠå¤©ç³»ç»Ÿ - ç¾¤èŠ</title>
    <link rel="stylesheet" href="notification_style.css">
    <link rel="stylesheet" href="mobile_optimization.css">
    <style>
        :root {
            --primary-color: #8C1C13; /* é…’çº¢è‰² */
            --secondary-color: #F5F5DC; /* ç±³ç™½è‰² */
            --text-color: #333;
            --border-color: #ddd;
            --highlight-color: #e6e6e6;
            --success-color: #4CAF50;
            --danger-color: #f44336;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f1f1f1;
            color: var(--text-color);
            font-size: 16px;
            line-height: 1.5;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
        }
        
        .header h2 {
            font-size: 20px;
        }
        
        .header-btn {
            background: none;
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .main-container {
            margin-top: 56px;
            margin-bottom: 60px;
            height: calc(100vh - 116px);
            overflow-y: auto;
        }
        
        .group-list {
            background-color: white;
        }
        
        .group-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .group-avatar {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background-color: var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            font-size: 20px;
            color: white;
        }
        
        .group-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .group-name {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .group-message {
            font-size: 14px;
            color: #777;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .group-time {
            font-size: 12px;
            color: #999;
            position: absolute;
            top: 15px;
            right: 15px;
        }
        
        .group-badge {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .pinned-icon {
            position: absolute;
            top: 40px;
            right: 15px;
            color: var(--primary-color);
            font-size: 14px;
        }
        
        .muted-icon {
            position: absolute;
            top: 40px;
            right: 35px;
            color: #999;
            font-size: 14px;
        }
        
        .create-group-btn {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 99;
            cursor: pointer;
        }
        
        .bottom-nav {
            display: flex;
            background-color: var(--secondary-color);
            border-top: 1px solid var(--border-color);
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 60px;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 8px 0;
            font-size: 14px;
            color: var(--text-color);
            cursor: pointer;
        }
        
        .nav-item.active {
            color: var(--primary-color);
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 2px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-group textarea {
            height: 80px;
            resize: none;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
        }
        
        .cancel-btn {
            background-color: #f1f1f1;
            color: var(--text-color);
        }
        
        .confirm-btn {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æ¶ˆæ¯æç¤º */
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            display: none;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px 20px;
            text-align: center;
        }
        
        .empty-icon {
            font-size: 60px;
            color: #ccc;
            margin-bottom: 20px;
        }
        
        .empty-text {
            font-size: 16px;
            color: #999;
            margin-bottom: 20px;
        }
        
        .empty-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        
        /* å¥½å‹é€‰æ‹©å™¨ */
        .friend-selector {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .friend-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .friend-item:last-child {
            border-bottom: none;
        }
        
        .friend-checkbox {
            margin-right: 10px;
        }
        
        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e1e1e1;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            font-size: 16px;
            color: var(--primary-color);
        }
        
        .friend-name {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>ç¾¤èŠ</h2>
        <button class="header-btn" id="logoutBtn">é€€å‡ºç™»å½•</button>
    </div>
    
    <div class="main-container">
        <div class="group-list" id="group-list">
            <div class="loading" id="groups-loading">
                <div class="loading-spinner"></div>
            </div>
        </div>
        
        <div class="empty-state" id="empty-state" style="display: none;">
            <div class="empty-icon">ğŸ‘¥</div>
            <div class="empty-text">æ‚¨è¿˜æ²¡æœ‰åŠ å…¥ä»»ä½•ç¾¤èŠ</div>
            <button class="empty-btn" id="createGroupBtn">åˆ›å»ºç¾¤èŠ</button>
        </div>
    </div>
    
    <div class="create-group-btn" id="createGroupBtnFloat">+</div>
    
    <div class="bottom-nav">
        <div class="nav-item" data-page="chat">
            <div class="nav-icon">ğŸ’¬</div>
            <div>èŠå¤©</div>
        </div>
        <div class="nav-item" data-page="contacts">
            <div class="nav-icon">ğŸ‘¥</div>
            <div>è”ç³»äºº</div>
        </div>
        <div class="nav-item active" data-page="groups">
            <div class="nav-icon">ğŸ‘ª</div>
            <div>ç¾¤èŠ</div>
        </div>
        <div class="nav-item" data-page="me">
            <div class="nav-icon">ğŸ‘¤</div>
            <div>æˆ‘çš„</div>
        </div>
    </div>
    
    <!-- åˆ›å»ºç¾¤èŠæ¨¡æ€æ¡† -->
    <div class="modal" id="createGroupModal">
        <div class="modal-content">
            <div class="modal-title">åˆ›å»ºç¾¤èŠ</div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="groupName">ç¾¤èŠåç§°</label>
                    <input type="text" id="groupName" placeholder="è¯·è¾“å…¥ç¾¤èŠåç§°">
                </div>
                <div class="form-group">
                    <label for="groupDescription">ç¾¤èŠæè¿°ï¼ˆé€‰å¡«ï¼‰</label>
                    <textarea id="groupDescription" placeholder="è¯·è¾“å…¥ç¾¤èŠæè¿°"></textarea>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©å¥½å‹</label>
                    <div class="friend-selector" id="friendSelector">
                        <div class="loading" id="friends-loading">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel-btn" id="cancelCreateGroup">å–æ¶ˆ</button>
                <button class="modal-btn confirm-btn" id="confirmCreateGroup">åˆ›å»º</button>
            </div>
        </div>
    </div>
    
    <!-- ç¾¤èŠè®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="groupSettingsModal">
        <div class="modal-content">
            <div class="modal-title">ç¾¤èŠè®¾ç½®</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="pinGroup"> ç½®é¡¶èŠå¤©
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="muteGroup"> æ¶ˆæ¯å…æ‰“æ‰°
                    </label>
                </div>
                <div class="form-group" id="adminOptions" style="display: none;">
                    <button class="modal-btn confirm-btn" style="width: 100%; margin: 5px 0;" id="editGroupBtn">ä¿®æ”¹ç¾¤èµ„æ–™</button>
                    <button class="modal-btn confirm-btn" style="width: 100%; margin: 5px 0;" id="inviteFriendsBtn">é‚€è¯·å¥½å‹</button>
                </div>
                <div class="form-group" id="ownerOptions" style="display: none;">
                    <button class="modal-btn confirm-btn" style="width: 100%; margin: 5px 0;" id="transferOwnerBtn">è½¬è®©ç¾¤ä¸»</button>
                    <button class="modal-btn danger-btn" style="width: 100%; margin: 5px 0; background-color: var(--danger-color); color: white;" id="dissolveGroupBtn">è§£æ•£ç¾¤èŠ</button>
                </div>
                <div class="form-group">
                    <button class="modal-btn danger-btn" style="width: 100%; margin: 5px 0; background-color: var(--danger-color); color: white;" id="leaveGroupBtn">é€€å‡ºç¾¤èŠ</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel-btn" id="closeGroupSettings">å…³é—­</button>
                <button class="modal-btn confirm-btn" id="saveGroupSettings">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- ä¿®æ”¹ç¾¤èµ„æ–™æ¨¡æ€æ¡† -->
    <div class="modal" id="editGroupModal">
        <div class="modal-content">
            <div class="modal-title">ä¿®æ”¹ç¾¤èµ„æ–™</div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editGroupName">ç¾¤èŠåç§°</label>
                    <input type="text" id="editGroupName" placeholder="è¯·è¾“å…¥ç¾¤èŠåç§°">
                </div>
                <div class="form-group">
                    <label for="editGroupDescription">ç¾¤èŠæè¿°ï¼ˆé€‰å¡«ï¼‰</label>
                    <textarea id="editGroupDescription" placeholder="è¯·è¾“å…¥ç¾¤èŠæè¿°"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel-btn" id="cancelEditGroup">å–æ¶ˆ</button>
                <button class="modal-btn confirm-btn" id="confirmEditGroup">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- é‚€è¯·å¥½å‹æ¨¡æ€æ¡† -->
    <div class="modal" id="inviteFriendsModal">
        <div class="modal-content">
            <div class="modal-title">é‚€è¯·å¥½å‹</div>
            <div class="modal-body">
                <div class="friend-selector" id="inviteFriendSelector">
                    <div class="loading" id="invite-friends-loading">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel-btn" id="cancelInviteFriends">å–æ¶ˆ</button>
                <button class="modal-btn confirm-btn" id="confirmInviteFriends">é‚€è¯·</button>
            </div>
        </div>
    </div>
    
    <!-- è½¬è®©ç¾¤ä¸»æ¨¡æ€æ¡† -->
    <div class="modal" id="transferOwnerModal">
        <div class="modal-content">
            <div class="modal-title">è½¬è®©ç¾¤ä¸»</div>
            <div class="modal-body">
                <div class="friend-selector" id="memberSelector">
                    <div class="loading" id="members-loading">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel-btn" id="cancelTransferOwner">å–æ¶ˆ</button>
                <button class="modal-btn confirm-btn" id="confirmTransferOwner">è½¬è®©</button>
            </div>
        </div>
    </div>
    
    <!-- ç¡®è®¤è§£æ•£ç¾¤èŠæ¨¡æ€æ¡† -->
    <div class="modal" id="confirmDissolveModal">
        <div class="modal-content">
            <div class="modal-title">è§£æ•£ç¾¤èŠ</div>
            <div class="modal-body">
                ç¡®å®šè¦è§£æ•£è¯¥ç¾¤èŠå—ï¼Ÿè§£æ•£åæ‰€æœ‰ç¾¤æˆå‘˜å°†è¢«ç§»é™¤ï¼Œç¾¤èŠæ¶ˆæ¯å°†æ— æ³•æ¢å¤ã€‚
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel-btn" id="cancelDissolveGroup">å–æ¶ˆ</button>
                <button class="modal-btn danger-btn" style="background-color: var(--danger-color); color: white;" id="confirmDissolveGroup">è§£æ•£</button>
            </div>
        </div>
    </div>
    
    <!-- ç¡®è®¤é€€å‡ºç¾¤èŠæ¨¡æ€æ¡† -->
    <div class="modal" id="confirmLeaveModal">
        <div class="modal-content">
            <div class="modal-title">é€€å‡ºç¾¤èŠ</div>
            <div class="modal-body">
                ç¡®å®šè¦é€€å‡ºè¯¥ç¾¤èŠå—ï¼Ÿé€€å‡ºåå°†ä¸å†æ¥æ”¶è¯¥ç¾¤çš„æ¶ˆæ¯ã€‚
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel-btn" id="cancelLeaveGroup">å–æ¶ˆ</button>
                <button class="modal-btn danger-btn" style="background-color: var(--danger-color); color: white;" id="confirmLeaveGroup">é€€å‡º</button>
            </div>
        </div>
    </div>
    
    <!-- æ¶ˆæ¯æç¤º -->
    <div class="toast" id="toast"></div>
    
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script>
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');
        
        if (!token || !username) {
            window.location.href = 'login.html';
        }
        
        // å…¨å±€å˜é‡
        let currentGroupId = null;
        let currentGroupData = null;
        let socket = null;
        let myFriends = [];
        let groupMembers = [];
        
        // åˆå§‹åŒ–Socket.ioè¿æ¥
        function initSocket() {
            socket = io();
            
            // è®¤è¯
            socket.emit('authenticate', token);
            
            // ç›‘å¬ç¾¤ç»„é‚€è¯·
            socket.on('group_invitation', (data) => {
                showToast(`${data.inviter_name} é‚€è¯·æ‚¨åŠ å…¥ç¾¤èŠ "${data.group_name}"`);
                loadGroups();
            });
            
            // ç›‘å¬ç¾¤ç»„è§£æ•£
            socket.on('group_dissolved', (data) => {
                showToast(`ç¾¤èŠå·²è¢« ${data.dissolver_name} è§£æ•£`);
                loadGroups();
            });
            
            // ç›‘å¬ç¾¤ä¸»è½¬è®©
            socket.on('group_owner_transferred', (data) => {
                showToast(`æ‚¨å·²æˆä¸ºç¾¤èŠ "${data.group_name}" çš„æ–°ç¾¤ä¸»`);
                loadGroups();
            });
            
            // ç›‘å¬ç¾¤ç»„å…¬å‘Š
            socket.on('group_announcement', (data) => {
                showToast(data.message);
            });
            
            // ç›‘å¬ç¾¤ç»„åç§°å˜æ›´
            socket.on('group_name_changed', (data) => {
                showToast(`ç¾¤èŠåç§°å·²ä» "${data.old_name}" å˜æ›´ä¸º "${data.new_name}"`);
                loadGroups();
            });
            
            // ç›‘å¬ç¾¤ç»„æ¶ˆæ¯
            socket.on('group_message', (data) => {
                // å¦‚æœä¸æ˜¯å½“å‰æŸ¥çœ‹çš„ç¾¤èŠï¼Œæ›´æ–°æœªè¯»æ¶ˆæ¯æ•°
                if (data.group_id !== currentGroupId) {
                    loadGroups();
                }
            });
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            // ä»Šå¤©çš„æ¶ˆæ¯åªæ˜¾ç¤ºæ—¶é—´
            if (diff < 24 * 60 * 60 * 1000 && date.getDate() === now.getDate()) {
                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            }
            
            // æ˜¨å¤©çš„æ¶ˆæ¯æ˜¾ç¤º"æ˜¨å¤©"
            const yesterday = new Date(now);
            yesterday.setDate(now.getDate() - 1);
            if (date.getDate() === yesterday.getDate() && date.getMonth() === yesterday.getMonth() && date.getFullYear() === yesterday.getFullYear()) {
                return 'æ˜¨å¤©';
            }
            
            // ä¸€å‘¨å†…çš„æ¶ˆæ¯æ˜¾ç¤ºæ˜ŸæœŸå‡ 
            if (diff < 7 * 24 * 60 * 60 * 1000) {
                const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                return 'æ˜ŸæœŸ' + weekdays[date.getDay()];
            }
            
            // å…¶ä»–æ¶ˆæ¯æ˜¾ç¤ºæ—¥æœŸ
            return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
        }
        
        // åŠ è½½ç¾¤èŠåˆ—è¡¨
        function loadGroups() {
            const groupList = document.getElementById('group-list');
            const groupsLoading = document.getElementById('groups-loading');
            const emptyState = document.getElementById('empty-state');
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            groupsLoading.style.display = 'block';
            emptyState.style.display = 'none';
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            const existingItems = groupList.querySelectorAll('.group-item');
            existingItems.forEach(item => item.remove());
            
            fetch('/api/groups', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–ç¾¤èŠåˆ—è¡¨å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                // éšè—åŠ è½½åŠ¨ç”»
                groupsLoading.style.display = 'none';
                
                if (data.groups && data.groups.length > 0) {
                    data.groups.forEach(group => {
                        const groupItem = document.createElement('div');
                        groupItem.className = 'group-item';
                        groupItem.setAttribute('data-id', group.id);
                        
                        // è·å–ç¾¤åé¦–å­—æ¯ä½œä¸ºå¤´åƒ
                        const initial = group.name.charAt(0).toUpperCase();
                        
                        // æ ¼å¼åŒ–æœ€åæ¶ˆæ¯æ—¶é—´
                        const timeStr = group.last_message_time ? formatTime(group.last_message_time) : '';
                        
                        groupItem.innerHTML = `
                            <div class="group-avatar">${initial}</div>
                            <div class="group-info">
                                <div class="group-name">${group.name}</div>
                                <div class="group-message">${group.last_message || ''}</div>
                            </div>
                            <div class="group-time">${timeStr}</div>
                            ${group.is_pinned ? '<div class="pinned-icon">ğŸ“Œ</div>' : ''}
                            ${group.is_muted ? '<div class="muted-icon">ğŸ”•</div>' : ''}
                        `;
                        
                        groupList.appendChild(groupItem);
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        groupItem.addEventListener('click', function() {
                            const groupId = this.getAttribute('data-id');
                            // è·³è½¬åˆ°ç¾¤èŠæ¶ˆæ¯é¡µé¢
                            localStorage.setItem('currentChat', JSON.stringify({
                                id: groupId,
                                name: group.name,
                                type: 'group'
                            }));
                            window.location.href = 'chat_with_notifications.html';
                        });
                        
                        // æ·»åŠ é•¿æŒ‰äº‹ä»¶
                        let pressTimer;
                        groupItem.addEventListener('touchstart', function() {
                            pressTimer = setTimeout(() => {
                                openGroupSettings(group.id);
                            }, 500);
                        });
                        
                        groupItem.addEventListener('touchend', function() {
                            clearTimeout(pressTimer);
                        });
                        
                        groupItem.addEventListener('contextmenu', function(e) {
                            e.preventDefault();
                            openGroupSettings(group.id);
                        });
                    });
                } else {
                    emptyState.style.display = 'flex';
                }
            })
            .catch(error => {
                console.error('è·å–ç¾¤èŠåˆ—è¡¨å¤±è´¥:', error);
                groupsLoading.style.display = 'none';
                emptyState.style.display = 'flex';
                showToast('è·å–ç¾¤èŠåˆ—è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }
        
        // æ‰“å¼€ç¾¤èŠè®¾ç½®
        function openGroupSettings(groupId) {
            currentGroupId = groupId;
            
            // è·å–ç¾¤èŠè¯¦æƒ…
            fetch(`/api/groups/${groupId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–ç¾¤èŠè¯¦æƒ…å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                currentGroupData = data;
                
                // è®¾ç½®ç½®é¡¶å’Œé™éŸ³çŠ¶æ€
                document.getElementById('pinGroup').checked = data.settings.is_pinned;
                document.getElementById('muteGroup').checked = data.settings.is_muted;
                
                // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºä¸åŒé€‰é¡¹
                const adminOptions = document.getElementById('adminOptions');
                const ownerOptions = document.getElementById('ownerOptions');
                const leaveGroupBtn = document.getElementById('leaveGroupBtn');
                
                if (data.userRole === 'admin') {
                    adminOptions.style.display = 'block';
                    
                    // å¦‚æœæ˜¯ç¾¤ä¸»ï¼Œæ˜¾ç¤ºç¾¤ä¸»é€‰é¡¹
                    if (data.group.creator_id === parseInt(localStorage.getItem('userId'))) {
                        ownerOptions.style.display = 'block';
                        leaveGroupBtn.style.display = 'none';
                    } else {
                        ownerOptions.style.display = 'none';
                        leaveGroupBtn.style.display = 'block';
                    }
                } else {
                    adminOptions.style.display = 'none';
                    ownerOptions.style.display = 'none';
                    leaveGroupBtn.style.display = 'block';
                }
                
                // æ˜¾ç¤ºè®¾ç½®æ¨¡æ€æ¡†
                document.getElementById('groupSettingsModal').style.display = 'block';
            })
            .catch(error => {
                console.error('è·å–ç¾¤èŠè¯¦æƒ…å¤±è´¥:', error);
                showToast('è·å–ç¾¤èŠè¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }
        
        // åŠ è½½å¥½å‹åˆ—è¡¨
        function loadFriends() {
            const friendSelector = document.getElementById('friendSelector');
            const friendsLoading = document.getElementById('friends-loading');
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            friendsLoading.style.display = 'block';
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            const existingItems = friendSelector.querySelectorAll('.friend-item');
            existingItems.forEach(item => item.remove());
            
            fetch('/api/friends', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–å¥½å‹åˆ—è¡¨å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                // éšè—åŠ è½½åŠ¨ç”»
                friendsLoading.style.display = 'none';
                
                if (data.friends && data.friends.length > 0) {
                    myFriends = data.friends;
                    
                    data.friends.forEach(friend => {
                        const friendItem = document.createElement('div');
                        friendItem.className = 'friend-item';
                        
                        // è·å–åå­—é¦–å­—æ¯ä½œä¸ºå¤´åƒ
                        const initial = friend.username.charAt(0).toUpperCase();
                        
                        friendItem.innerHTML = `
                            <input type="checkbox" class="friend-checkbox" data-id="${friend.id}">
                            <div class="friend-avatar">${initial}</div>
                            <div class="friend-name">${friend.username}</div>
                        `;
                        
                        friendSelector.appendChild(friendItem);
                    });
                } else {
                    friendSelector.innerHTML = '<div class="empty-message">æš‚æ— å¥½å‹ï¼Œè¯·å…ˆæ·»åŠ å¥½å‹</div>';
                }
            })
            .catch(error => {
                console.error('è·å–å¥½å‹åˆ—è¡¨å¤±è´¥:', error);
                friendsLoading.style.display = 'none';
                friendSelector.innerHTML = '<div class="empty-message">è·å–å¥½å‹åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            });
        }
        
        // åŠ è½½å¯é‚€è¯·çš„å¥½å‹åˆ—è¡¨
        function loadInvitableFriends(groupId) {
            const inviteFriendSelector = document.getElementById('inviteFriendSelector');
            const inviteFriendsLoading = document.getElementById('invite-friends-loading');
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            inviteFriendsLoading.style.display = 'block';
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            const existingItems = inviteFriendSelector.querySelectorAll('.friend-item');
            existingItems.forEach(item => item.remove());
            
            // è·å–ç¾¤æˆå‘˜
            fetch(`/api/groups/${groupId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–ç¾¤èŠè¯¦æƒ…å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                groupMembers = data.members;
                
                // è·å–å¥½å‹åˆ—è¡¨
                return fetch('/api/friends', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–å¥½å‹åˆ—è¡¨å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                // éšè—åŠ è½½åŠ¨ç”»
                inviteFriendsLoading.style.display = 'none';
                
                if (data.friends && data.friends.length > 0) {
                    // è¿‡æ»¤æ‰å·²ç»æ˜¯ç¾¤æˆå‘˜çš„å¥½å‹
                    const memberIds = groupMembers.map(member => member.user_id);
                    const invitableFriends = data.friends.filter(friend => !memberIds.includes(friend.id));
                    
                    if (invitableFriends.length > 0) {
                        invitableFriends.forEach(friend => {
                            const friendItem = document.createElement('div');
                            friendItem.className = 'friend-item';
                            
                            // è·å–åå­—é¦–å­—æ¯ä½œä¸ºå¤´åƒ
                            const initial = friend.username.charAt(0).toUpperCase();
                            
                            friendItem.innerHTML = `
                                <input type="checkbox" class="friend-checkbox" data-id="${friend.id}">
                                <div class="friend-avatar">${initial}</div>
                                <div class="friend-name">${friend.username}</div>
                            `;
                            
                            inviteFriendSelector.appendChild(friendItem);
                        });
                    } else {
                        inviteFriendSelector.innerHTML = '<div class="empty-message">æ‰€æœ‰å¥½å‹éƒ½å·²ç»æ˜¯ç¾¤æˆå‘˜</div>';
                    }
                } else {
                    inviteFriendSelector.innerHTML = '<div class="empty-message">æš‚æ— å¥½å‹ï¼Œè¯·å…ˆæ·»åŠ å¥½å‹</div>';
                }
            })
            .catch(error => {
                console.error('åŠ è½½å¯é‚€è¯·å¥½å‹å¤±è´¥:', error);
                inviteFriendsLoading.style.display = 'none';
                inviteFriendSelector.innerHTML = '<div class="empty-message">åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            });
        }
        
        // åŠ è½½ç¾¤æˆå‘˜åˆ—è¡¨ï¼ˆç”¨äºè½¬è®©ç¾¤ä¸»ï¼‰
        function loadGroupMembers(groupId) {
            const memberSelector = document.getElementById('memberSelector');
            const membersLoading = document.getElementById('members-loading');
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            membersLoading.style.display = 'block';
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            const existingItems = memberSelector.querySelectorAll('.friend-item');
            existingItems.forEach(item => item.remove());
            
            fetch(`/api/groups/${groupId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–ç¾¤èŠè¯¦æƒ…å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                // éšè—åŠ è½½åŠ¨ç”»
                membersLoading.style.display = 'none';
                
                if (data.members && data.members.length > 0) {
                    // è¿‡æ»¤æ‰è‡ªå·±
                    const userId = parseInt(localStorage.getItem('userId'));
                    const otherMembers = data.members.filter(member => member.user_id !== userId);
                    
                    if (otherMembers.length > 0) {
                        otherMembers.forEach(member => {
                            const memberItem = document.createElement('div');
                            memberItem.className = 'friend-item';
                            
                            // è·å–åå­—é¦–å­—æ¯ä½œä¸ºå¤´åƒ
                            const initial = member.username.charAt(0).toUpperCase();
                            
                            memberItem.innerHTML = `
                                <input type="radio" name="newOwner" class="friend-checkbox" data-id="${member.user_id}">
                                <div class="friend-avatar">${initial}</div>
                                <div class="friend-name">${member.username}${member.role === 'admin' ? ' (ç®¡ç†å‘˜)' : ''}</div>
                            `;
                            
                            memberSelector.appendChild(memberItem);
                        });
                    } else {
                        memberSelector.innerHTML = '<div class="empty-message">ç¾¤é‡Œåªæœ‰æ‚¨ä¸€ä¸ªæˆå‘˜ï¼Œæ— æ³•è½¬è®©ç¾¤ä¸»</div>';
                    }
                } else {
                    memberSelector.innerHTML = '<div class="empty-message">è·å–ç¾¤æˆå‘˜å¤±è´¥</div>';
                }
            })
            .catch(error => {
                console.error('è·å–ç¾¤æˆå‘˜å¤±è´¥:', error);
                membersLoading.style.display = 'none';
                memberSelector.innerHTML = '<div class="empty-message">è·å–ç¾¤æˆå‘˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            });
        }
        
        // åˆ›å»ºç¾¤èŠ
        function createGroup() {
            const groupName = document.getElementById('groupName').value.trim();
            const groupDescription = document.getElementById('groupDescription').value.trim();
            const friendCheckboxes = document.querySelectorAll('#friendSelector .friend-checkbox:checked');
            
            if (!groupName) {
                showToast('è¯·è¾“å…¥ç¾¤èŠåç§°');
                return;
            }
            
            const memberIds = Array.from(friendCheckboxes).map(checkbox => parseInt(checkbox.getAttribute('data-id')));
            
            fetch('/api/groups', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    name: groupName,
                    description: groupDescription,
                    memberIds
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('åˆ›å»ºç¾¤èŠå¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                showToast('ç¾¤èŠåˆ›å»ºæˆåŠŸ');
                
                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('createGroupModal').style.display = 'none';
                
                // é‡æ–°åŠ è½½ç¾¤èŠåˆ—è¡¨
                loadGroups();
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('groupName').value = '';
                document.getElementById('groupDescription').value = '';
                friendCheckboxes.forEach(checkbox => checkbox.checked = false);
            })
            .catch(error => {
                console.error('åˆ›å»ºç¾¤èŠå¤±è´¥:', error);
                showToast('åˆ›å»ºç¾¤èŠå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }
        
        // ä¿å­˜ç¾¤èŠè®¾ç½®
        function saveGroupSettings() {
            const isPinned = document.getElementById('pinGroup').checked;
            const isMuted = document.getElementById('muteGroup').checked;
            
            fetch(`/api/groups/${currentGroupId}/settings`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    isPinned,
                    isMuted
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ä¿å­˜ç¾¤èŠè®¾ç½®å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                showToast('ç¾¤èŠè®¾ç½®å·²ä¿å­˜');
                
                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('groupSettingsModal').style.display = 'none';
                
                // é‡æ–°åŠ è½½ç¾¤èŠåˆ—è¡¨
                loadGroups();
            })
            .catch(error => {
                console.error('ä¿å­˜ç¾¤èŠè®¾ç½®å¤±è´¥:', error);
                showToast('ä¿å­˜ç¾¤èŠè®¾ç½®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }
        
        // ä¿®æ”¹ç¾¤èµ„æ–™
        function editGroup() {
            const groupName = document.getElementById('editGroupName').value.trim();
            const groupDescription = document.getElementById('editGroupDescription').value.trim();
            
            if (!groupName) {
                showToast('è¯·è¾“å…¥ç¾¤èŠåç§°');
                return;
            }
            
            fetch(`/api/groups/${currentGroupId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    name: groupName,
                    description: groupDescription
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ä¿®æ”¹ç¾¤èµ„æ–™å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                showToast('ç¾¤èµ„æ–™å·²æ›´æ–°');
                
                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('editGroupModal').style.display = 'none';
                
                // é‡æ–°åŠ è½½ç¾¤èŠåˆ—è¡¨
                loadGroups();
            })
            .catch(error => {
                console.error('ä¿®æ”¹ç¾¤èµ„æ–™å¤±è´¥:', error);
                showToast('ä¿®æ”¹ç¾¤èµ„æ–™å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }
        
        // é‚€è¯·å¥½å‹åŠ å…¥ç¾¤èŠ
        function inviteFriends() {
            const friendCheckboxes = document.querySelectorAll('#inviteFriendSelector .friend-checkbox:checked');
            
            if (friendCheckboxes.length === 0) {
                showToast('è¯·é€‰æ‹©è¦é‚€è¯·çš„å¥½å‹');
                return;
            }
            
            const friendIds = Array.from(friendCheckboxes).map(checkbox => parseInt(checkbox.getAttribute('data-id')));
            
            fetch(`/api/groups/${currentGroupId}/invite`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    friendIds
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('é‚€è¯·å¥½å‹å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                showToast(data.message);
                
                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('inviteFriendsModal').style.display = 'none';
            })
            .catch(error => {
                console.error('é‚€è¯·å¥½å‹å¤±è´¥:', error);
                showToast('é‚€è¯·å¥½å‹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }
        
        // è½¬è®©ç¾¤ä¸»
        function transferOwner() {
            const newOwnerRadio = document.querySelector('#memberSelector input[name="newOwner"]:checked');
            
            if (!newOwnerRadio) {
                showToast('è¯·é€‰æ‹©æ–°ç¾¤ä¸»');
                return;
            }
            
            const newOwnerId = parseInt(newOwnerRadio.getAttribute('data-id'));
            
            fetch(`/api/groups/${currentGroupId}/transfer`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    newOwnerId
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è½¬è®©ç¾¤ä¸»å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                showToast(data.message);
                
                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('transferOwnerModal').style.display = 'none';
                document.getElementById('groupSettingsModal').style.display = 'none';
                
                // é‡æ–°åŠ è½½ç¾¤èŠåˆ—è¡¨
                loadGroups();
            })
            .catch(error => {
                console.error('è½¬è®©ç¾¤ä¸»å¤±è´¥:', error);
                showToast('è½¬è®©ç¾¤ä¸»å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }
        
        // è§£æ•£ç¾¤èŠ
        function dissolveGroup() {
            fetch(`/api/groups/${currentGroupId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è§£æ•£ç¾¤èŠå¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                showToast(data.message);
                
                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('confirmDissolveModal').style.display = 'none';
                document.getElementById('groupSettingsModal').style.display = 'none';
                
                // é‡æ–°åŠ è½½ç¾¤èŠåˆ—è¡¨
                loadGroups();
            })
            .catch(error => {
                console.error('è§£æ•£ç¾¤èŠå¤±è´¥:', error);
                showToast('è§£æ•£ç¾¤èŠå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }
        
        // é€€å‡ºç¾¤èŠ
        function leaveGroup() {
            fetch(`/api/groups/${currentGroupId}/leave`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('é€€å‡ºç¾¤èŠå¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                showToast(data.message);
                
                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('confirmLeaveModal').style.display = 'none';
                document.getElementById('groupSettingsModal').style.display = 'none';
                
                // é‡æ–°åŠ è½½ç¾¤èŠåˆ—è¡¨
                loadGroups();
            })
            .catch(error => {
                console.error('é€€å‡ºç¾¤èŠå¤±è´¥:', error);
                showToast('é€€å‡ºç¾¤èŠå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }
        
        // åº•éƒ¨å¯¼èˆª
        const navItems = document.querySelectorAll('.nav-item');
        
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                const pageName = this.getAttribute('data-page');
                
                // æ¿€æ´»å½“å‰å¯¼èˆªé¡¹
                navItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                // é¡µé¢è·³è½¬
                if (pageName === 'chat') {
                    window.location.href = 'chat_with_notifications.html';
                } else if (pageName === 'contacts') {
                    window.location.href = 'friend_system_frontend_improvements.html';
                } else if (pageName === 'me') {
                    // ä¸ªäººè®¾ç½®é¡µé¢ï¼Œæš‚æœªå®ç°
                    showToast('ä¸ªäººè®¾ç½®åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­');
                }
            });
        });
        
        // åˆ›å»ºç¾¤èŠæŒ‰é’®
        document.getElementById('createGroupBtn').addEventListener('click', function() {
            document.getElementById('createGroupModal').style.display = 'block';
            loadFriends();
        });
        
        document.getElementById('createGroupBtnFloat').addEventListener('click', function() {
            document.getElementById('createGroupModal').style.display = 'block';
            loadFriends();
        });
        
        // ç¡®è®¤åˆ›å»ºç¾¤èŠ
        document.getElementById('confirmCreateGroup').addEventListener('click', createGroup);
        
        // å–æ¶ˆåˆ›å»ºç¾¤èŠ
        document.getElementById('cancelCreateGroup').addEventListener('click', function() {
            document.getElementById('createGroupModal').style.display = 'none';
        });
        
        // ä¿å­˜ç¾¤èŠè®¾ç½®
        document.getElementById('saveGroupSettings').addEventListener('click', saveGroupSettings);
        
        // å…³é—­ç¾¤èŠè®¾ç½®
        document.getElementById('closeGroupSettings').addEventListener('click', function() {
            document.getElementById('groupSettingsModal').style.display = 'none';
        });
        
        // ä¿®æ”¹ç¾¤èµ„æ–™æŒ‰é’®
        document.getElementById('editGroupBtn').addEventListener('click', function() {
            document.getElementById('groupSettingsModal').style.display = 'none';
            document.getElementById('editGroupModal').style.display = 'block';
            
            // å¡«å……å½“å‰ç¾¤èµ„æ–™
            document.getElementById('editGroupName').value = currentGroupData.group.name;
            document.getElementById('editGroupDescription').value = currentGroupData.group.description || '';
        });
        
        // ç¡®è®¤ä¿®æ”¹ç¾¤èµ„æ–™
        document.getElementById('confirmEditGroup').addEventListener('click', editGroup);
        
        // å–æ¶ˆä¿®æ”¹ç¾¤èµ„æ–™
        document.getElementById('cancelEditGroup').addEventListener('click', function() {
            document.getElementById('editGroupModal').style.display = 'none';
            document.getElementById('groupSettingsModal').style.display = 'block';
        });
        
        // é‚€è¯·å¥½å‹æŒ‰é’®
        document.getElementById('inviteFriendsBtn').addEventListener('click', function() {
            document.getElementById('groupSettingsModal').style.display = 'none';
            document.getElementById('inviteFriendsModal').style.display = 'block';
            loadInvitableFriends(currentGroupId);
        });
        
        // ç¡®è®¤é‚€è¯·å¥½å‹
        document.getElementById('confirmInviteFriends').addEventListener('click', inviteFriends);
        
        // å–æ¶ˆé‚€è¯·å¥½å‹
        document.getElementById('cancelInviteFriends').addEventListener('click', function() {
            document.getElementById('inviteFriendsModal').style.display = 'none';
            document.getElementById('groupSettingsModal').style.display = 'block';
        });
        
        // è½¬è®©ç¾¤ä¸»æŒ‰é’®
        document.getElementById('transferOwnerBtn').addEventListener('click', function() {
            document.getElementById('groupSettingsModal').style.display = 'none';
            document.getElementById('transferOwnerModal').style.display = 'block';
            loadGroupMembers(currentGroupId);
        });
        
        // ç¡®è®¤è½¬è®©ç¾¤ä¸»
        document.getElementById('confirmTransferOwner').addEventListener('click', transferOwner);
        
        // å–æ¶ˆè½¬è®©ç¾¤ä¸»
        document.getElementById('cancelTransferOwner').addEventListener('click', function() {
            document.getElementById('transferOwnerModal').style.display = 'none';
            document.getElementById('groupSettingsModal').style.display = 'block';
        });
        
        // è§£æ•£ç¾¤èŠæŒ‰é’®
        document.getElementById('dissolveGroupBtn').addEventListener('click', function() {
            document.getElementById('groupSettingsModal').style.display = 'none';
            document.getElementById('confirmDissolveModal').style.display = 'block';
        });
        
        // ç¡®è®¤è§£æ•£ç¾¤èŠ
        document.getElementById('confirmDissolveGroup').addEventListener('click', dissolveGroup);
        
        // å–æ¶ˆè§£æ•£ç¾¤èŠ
        document.getElementById('cancelDissolveGroup').addEventListener('click', function() {
            document.getElementById('confirmDissolveModal').style.display = 'none';
            document.getElementById('groupSettingsModal').style.display = 'block';
        });
        
        // é€€å‡ºç¾¤èŠæŒ‰é’®
        document.getElementById('leaveGroupBtn').addEventListener('click', function() {
            document.getElementById('groupSettingsModal').style.display = 'none';
            document.getElementById('confirmLeaveModal').style.display = 'block';
        });
        
        // ç¡®è®¤é€€å‡ºç¾¤èŠ
        document.getElementById('confirmLeaveGroup').addEventListener('click', leaveGroup);
        
        // å–æ¶ˆé€€å‡ºç¾¤èŠ
        document.getElementById('cancelLeaveGroup').addEventListener('click', function() {
            document.getElementById('confirmLeaveModal').style.display = 'none';
            document.getElementById('groupSettingsModal').style.display = 'block';
        });
        
        // é€€å‡ºç™»å½•
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        });
        
        // åˆå§‹åŒ–
        function init() {
            // åˆå§‹åŒ–Socket.ioè¿æ¥
            initSocket();
            
            // åŠ è½½ç¾¤èŠåˆ—è¡¨
            loadGroups();
            
            // å­˜å‚¨ç”¨æˆ·ID
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    localStorage.setItem('userId', payload.id);
                } catch (error) {
                    console.error('è§£ætokenå¤±è´¥:', error);
                }
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
