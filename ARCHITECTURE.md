# SafeChat 部署架构图

## 场景 1：同域部署（推荐）

```
┌─────────────────────────────────────────────────────────┐
│                    https://yourdomain.com                │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │              Nginx 反向代理                         │ │
│  │                                                     │ │
│  │  /           → 前端静态文件                         │ │
│  │  /api/*      → localhost:3001/api/*                 │ │
│  │  /socket.io/ → localhost:3001/socket.io/            │ │
│  └────────────────────────────────────────────────────┘ │
│                          │                               │
│  ┌───────────┐          │          ┌─────────────┐     │
│  │  前端静态  │          └─────────>│  后端服务    │     │
│  │   文件    │                     │  (Node.js)  │     │
│  │           │                     │  :3001      │     │
│  └───────────┘                     └─────────────┘     │
│                                           │             │
│                                           ▼             │
│                                    ┌─────────────┐     │
│                                    │  MongoDB    │     │
│                                    └─────────────┘     │
└─────────────────────────────────────────────────────────┘

配置：
  frontend/modern/config.js:
    apiBaseUrl: ''
    socketUrl: undefined

  backend 环境变量:
    ALLOWED_ORIGINS="*"
```

## 场景 2：独立域名部署

```
┌──────────────────────────┐      ┌──────────────────────────┐
│ https://chat.example.com │      │ https://api.example.com  │
│                          │      │                          │
│  ┌────────────────────┐  │      │  ┌────────────────────┐  │
│  │   前端静态文件      │  │      │  │   后端服务         │  │
│  │   (Nginx/Apache)   │  │      │  │   (Node.js)        │  │
│  └────────────────────┘  │      │  └────────────────────┘  │
│            │             │      │            │             │
│            │             │      │            ▼             │
│            │             │      │     ┌─────────────┐     │
│            │  HTTP请求   │      │     │  MongoDB    │     │
│            └─────────────┼──────┼────>└─────────────┘     │
│                          │      │                          │
└──────────────────────────┘      └──────────────────────────┘

配置：
  frontend/modern/config.js:
    apiBaseUrl: 'https://api.example.com'
    socketUrl: 'https://api.example.com'

  backend 环境变量:
    ALLOWED_ORIGINS="https://chat.example.com"
```

## 场景 3：不同端口（开发/测试）

```
┌─────────────────────────────────────────────────────────┐
│                    localhost / 127.0.0.1                 │
│                                                          │
│  ┌────────────────┐              ┌────────────────┐     │
│  │  前端开发服务   │              │  后端开发服务   │     │
│  │  :8080 或       │   HTTP      │  :3001         │     │
│  │  file://       │  ──────────> │                │     │
│  │                │   请求       │  (npm start)   │     │
│  └────────────────┘              └────────────────┘     │
│                                          │              │
│                                          ▼              │
│                                   ┌─────────────┐      │
│                                   │  MongoDB    │      │
│                                   │  :27017     │      │
│                                   └─────────────┘      │
└─────────────────────────────────────────────────────────┘

配置：
  frontend/modern/config.js:
    apiBaseUrl: 'http://localhost:3001'
    socketUrl: 'http://localhost:3001'

  backend 环境变量:
    ALLOWED_ORIGINS="http://localhost:8080,http://127.0.0.1:8080"
```

## 数据流向

### REST API 请求流程
```
前端                      后端                     数据库
 │                         │                        │
 ├─ POST /api/login ──────>│                        │
 │                         ├─ 验证用户 ───────────>│
 │                         │<─ 返回用户数据 ────────┤
 │<─ 返回 JWT Token ───────┤                        │
 │                         │                        │
```

### WebSocket 连接流程
```
前端                      后端
 │                         │
 ├─ socket.connect() ────>│
 │<─ connect event ────────┤
 │                         │
 ├─ emit('authenticate')─>│
 │                         ├─ 验证 JWT
 │<─ authenticated ────────┤
 │                         │
 ├─ emit('joinConversation')>│
 │<─ messageCreated ───────┤ (实时消息推送)
 │                         │
```

## 选择建议

| 场景 | 适用情况 | 优点 | 缺点 |
|------|---------|------|------|
| 同域部署 | 生产环境 | 无需配置CORS，性能最优 | 需要配置反向代理 |
| 独立域名 | 微服务架构 | 前后端完全独立 | 需要处理CORS |
| 不同端口 | 本地开发 | 配置简单，调试方便 | 仅适用于开发 |

## 安全考虑

### 同域部署
- ✅ 无CORS风险
- ✅ Cookie可自动携带
- ⚠️ 需正确配置Nginx/Apache

### 独立域名
- ⚠️ 必须正确配置CORS
- ⚠️ 需要HTTPS避免中间人攻击
- ✅ 可独立扩展前后端

### 不同端口
- ⚠️ 仅用于开发，不可用于生产
- ⚠️ 存在CORS预检请求
- ✅ 调试方便

---

**推荐部署方式**：生产环境使用场景1（同域部署），开发环境使用场景3（不同端口）
